# Архитектурный план ERP-системы (полное соответствие ТЗ)

## 1. Назначение документа

Данный документ описывает целевую архитектуру ERP-системы **строго на основе документа «Техническое задание»**. Архитектура отражает реальные бизнес-процессы производства, ценообразования и управления заказами без упрощений и абстракций, противоречащих ТЗ.

Документ является **рабочей архитектурной спецификацией**, а не концептом.

---

## 2. Архитектурные принципы

### 2.1 Технологический стек
- Backend: **NestJS (LTS)**
- Язык: **TypeScript (`strict: true`)**
- БД: **PostgreSQL**
- ORM: TypeORM / Prisma (без ActiveRecord)
- API: REST + WebSocket

### 2.2 Инженерные принципы
- Clean Architecture
- DDD (Bounded Context, Aggregates, Value Objects)
- SOLID
- Отсутствие god-module / god-service
- Изолированные модули (`src/modules`)
- Комментарии и примечания в коде — **на русском языке**

---

## 3. Доменная модель (DDD)

### 3.1 Основные Bounded Context

| Контекст | Назначение |
|--------|------------|
| Order Management | Заказы, их структура, история, расчёты |
| Product Catalog | Номенклатуры, свойства, зависимости |
| Pricing | Базовые цены, модификаторы |
| User Management | Пользователи, роли, типы людей |
| Configuration | Шапки заказов, зависимости свойств |

---

## 4. Заказ как доменный агрегат

### 4.1 Агрегат `Order`

Order — **универсальный производственный документ**, а не только заявка на фасады.

**Сущности агрегата:**
- Order
- OrderItem (productInOrder)
- PropertyInOrder
- OrderLog

### 4.2 Поля Order

| Поле | Описание |
|-----|----------|
| id | Уникальный идентификатор |
| numberOrder | Сквозной номер заказа |
| typeOrder | Тип заказа (из справочника) |
| nameOrder | Наименование |
| dateOrder | Дата создания (авто) |
| dateStart | Дата запуска |
| dateComplete | Дедлайн (расчётный или ручной) |
| clientID | Клиент |
| agentID | Менеджер (кто сохранил) |
| square | Суммарная площадь (техническое поле) |
| note | Комментарий |

### 4.3 История изменений

Каждое изменение заказа:
- фиксируется
- связано с пользователем
- имеет дату и описание действия

Order является **event-driven агрегатом**.

---

## 5. Шапка заказа (Configuration Context)

### 5.1 Шапки заказа

Шапка — набор свойств, применяемых к позициям заказа.

**Особенности:**
- Шапка выбирается по типу заказа
- Свойства могут быть включены / отключены
- Свойства из шапки наследуются позициями заказа

### 5.2 Свойства шапки

Свойства:
- Материал заказа
- Модель фасада
- Филёнка
- Материал филёнки
- Текстура
- Цвет
- Патина
- Глянцевость
- Присадка (bool)
- Термошов (bool)
- Доп. параметры отделки

---

## 6. Номенклатуры и свойства

### 6.1 Номенклатура (Product)

Номенклатура — базовый элемент расчёта.

**Поля:**
- name
- category
- description
- unit
- defaultLength
- defaultWidth
- defaultDepth

### 6.2 Свойства номенклатуры

Каждая номенклатура имеет набор свойств через сущность `productProperty`:

| Поле | Назначение |
|-----|------------|
| propertyID | Свойство |
| isActive | Включено по умолчанию |
| defaultValue | Значение по умолчанию |

Свойства с `isActive = false` могут быть включены вручную в заказе.

---

## 7. Зависимости значений свойств

### 7.1 Механизм зависимостей

Система поддерживает зависимости вида:

> ЕСЛИ выбрано (Property A = Value X) → ТО автоматически установить (Property B = Value Y)

### 7.2 Назначение
- Автозаполнение
- Исключение ошибок
- Формализация технологических правил

---

## 8. Ценообразование

### 8.1 Базовая цена

Каждая номенклатура имеет **единственную базовую цену**.

### 8.2 Модификаторы цены

Цена изменяется **исключительно через модификаторы**:
- Свойство
- Значение свойства
- Изменение цены (+ / -)

### 8.3 Расчёт стоимости позиции

1. Базовая цена
2. Применение модификаторов
3. Умножение на площадь / п.м.
4. Применение коэффициента

---

## 9. Позиции заказа

### 9.1 OrderItem

Каждая строка заказа:
- может быть добавлена или скопирована
- содержит геометрию
- содержит собственные свойства

**Расчёты:**
- Площадь = длина × ширина × количество
- Погонный метр = длина × количество

---

## 10. Пользователи и роли

### 10.1 Пользователь

Пользователь — универсальная сущность для:
- Клиентов
- Менеджеров
- Работников

### 10.2 Дополнительные данные

Произвольные данные пользователя хранятся в `usersProperty`:
- несколько телефонов
- реквизиты
- примечания

---

## 11. Права доступа

- Права влияют на:
  - видимость колонок
  - доступ к ценам
  - действия над заказом

Реализация: RBAC + domain rules.

---

## 12. Логирование и аудит

Система логирует:
- изменения заказа
- изменения свойств
- перерасчёты цены

Лог — обязательная часть бизнес-логики.

---

## 13. Структура проекта

```text
src/
 └─ modules/
    ├─ order/
    ├─ product/
    ├─ pricing/
    ├─ property/
    ├─ user/
    ├─ configuration/
    └─ audit/
```

Каждый модуль:
- domain
- application
- infrastructure
- presentation

---

## 14. Заказ-наряды и производственные участки

### 14.1 Понятие заказ-наряда

**Заказ-наряд** — это производственный документ, формируемый на основе основного заказа (маршрутного листа) для **конкретного производственного участка**.

Заказ-наряд:
- всегда связан с основным заказом;
- относится к одному участку (цех, зона, операция);
- содержит только те позиции и операции, которые выполняются на данном участке;
- является основанием для расчёта заработной платы.

Система должна поддерживать заказ-наряды как для:
- клиентских заказов;
- внутрипроизводственных заявок.

---

### 14.2 Производственные участки

Производственный участок — логическая единица производства.

**Примеры участков:**
- Раскрой
- Присадка
- Покраска
- Сборка
- Упаковка

Каждый заказ может порождать **несколько заказ-нарядов**, по одному на участок.

---

## 15. Канбан заказ-нарядов

### 15.1 Канбан-доска

Для каждого участка должна существовать **канбан-доска заказ-нарядов**, отображающая текущие задачи.

**Статусы (пример):**
- Запланирован
- В работе
- На проверке
- Готов

### 15.2 Управление статусами

- Перемещение заказ-нарядов по канбану осуществляется бригадиром или ответственным лицом.
- Изменение статуса фиксируется в истории.
- Заказ-наряд считается выполненным только при переводе в финальный статус.

---

## 16. Контроль приоритетов выполнения

### 16.1 Срочность заказов

Каждый основной заказ имеет **дедлайн**.

Для заказ-нарядов на участке система обязана:
- определять самый срочный заказ;
- контролировать порядок выполнения;
- сигнализировать о нарушении очередности.

### 16.2 Ограничения

- Нельзя начать выполнение менее срочного заказ-наряда, если более срочный ожидает выполнения.
- Исключения допускаются только при наличии разрешения (роль + фиксация причины).

---

## 17. Назначение исполнителей

### 17.1 Назначение до начала работ

Исполнитель (или бригада) **обязательно назначается до начала выполнения заказ-наряда**.

Назначение фиксирует:
- работника;
- роль в работе;
- время начала.

Без назначенного исполнителя перевод в статус «В работе» запрещён.

---

## 18. Расчёт заработной платы

### 18.1 Типы оплаты труда

Система должна поддерживать:
- **Сдельную оплату**;
- **Оплату по нормо-часам**;
- **Оклад**.

### 18.2 Правила расчёта

- Один работник может иметь **только один активный тип оплаты**.
- Работник на окладе **не участвует** в сдельных и нормо-часовых расчётах.
- Тип оплаты определяется профилем работника.

### 18.3 Данные для расчёта

Заказ-наряд хранит:
- норму времени;
- фактическое время;
- сдельную расценку;
- рассчитанную сумму.

Зарплата формируется **исключительно на основании завершённых заказ-нарядов**.

---

## 19. Шапки и свойства для производственных заявок

### 19.1 Типы заявок

Система поддерживает различные типы заявок:
- клиентские заказы;
- внутрипроизводственные заявки.

### 19.2 Различие шапок

Для разных типов заявок:
- используются разные шапки;
- разные наборы доп.свойств;
- разные правила обязательности полей.

---

## 20. Модуль бухгалтерии

### 20.1 Учёт оплат от клиентов

В системе должен существовать **бухгалтерский модуль**, предназначенный для:
- регистрации приходов денежных средств от клиентов;
- формирования баланса клиента.

Каждый приход:
- имеет дату;
- сумму;
- основание (платёж, аванс и т.д.).

---

### 20.2 Баланс клиента

Баланс клиента:
- увеличивается при приходе;
- уменьшается при распределении оплат по заказам.

Баланс хранится агрегированно и по операциям.

---

### 20.3 Распределение оплат менеджером

Менеджер в своём модуле:
- видит баланс клиента;
- распределяет средства по заказам;
- фиксирует частичные и полные оплаты.

Оплата заказа:
- не может превышать доступный баланс;
- фиксируется в истории.

---

## 21. Итог

Система охватывает:
- полный цикл заказа;
- производство по участкам;
- контроль сроков;
- расчёт заработной платы;
- финансовый учёт.

Архитектура и ТЗ согласованы и готовы к дальнейшей детализации и реализации.

