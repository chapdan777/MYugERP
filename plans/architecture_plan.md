# Архитектурный план ERP-системы (полное соответствие ТЗ)

## 1. Назначение документа

Данный документ описывает целевую архитектуру ERP-системы **строго на основе документа «Техническое задание»**. Архитектура отражает реальные бизнес-процессы производства, ценообразования и управления заказами без упрощений и абстракций, противоречащих ТЗ.

Документ является **рабочей архитектурной спецификацией**, а не концептом.

---

## 2. Архитектурные принципы

### 2.1 Технологический стек
- Backend: **NestJS (LTS)**
- Язык: **TypeScript (`strict: true`)**
- БД: **PostgreSQL**
- ORM: TypeORM / Prisma (без ActiveRecord)
- API: REST + WebSocket

### 2.2 Инженерные принципы
- Clean Architecture
- DDD (Bounded Context, Aggregates, Value Objects)
- SOLID
- Отсутствие god-module / god-service
- Изолированные модули (`src/modules`)
- Комментарии и примечания в коде — **на русском языке**

---

## 3. Доменная модель (DDD)

### 3.1 Основные Bounded Context

| Контекст | Назначение |
|--------|------------|
| Order Management | Заказы, их структура, история, расчёты |
| Product Catalog | Номенклатуры, свойства, зависимости |
| Pricing | Базовые цены, модификаторы |
| User Management | Пользователи, роли, типы людей |
| Configuration | Шапки заказов, зависимости свойств |

---

## 4. Заказ как доменный агрегат

### 4.1 Агрегат `Order`

Order — **универсальный производственный документ**, а не только заявка на фасады.

**Сущности агрегата:**
- Order
- OrderItem (productInOrder)
- PropertyInOrder
- OrderLog

### 4.2 Поля Order

| Поле | Описание |
|-----|----------|
| id | Уникальный идентификатор |
| numberOrder | Сквозной номер заказа |
| typeOrder | Тип заказа (из справочника) |
| nameOrder | Наименование |
| dateOrder | Дата создания (авто) |
| dateStart | Дата запуска |
| dateComplete | Дедлайн (расчётный или ручной) |
| clientID | Клиент |
| agentID | Менеджер (кто сохранил) |
| square | Суммарная площадь (техническое поле) |
| note | Комментарий |

### 4.3 История изменений

Каждое изменение заказа:
- фиксируется
- связано с пользователем
- имеет дату и описание действия

Order является **event-driven агрегатом**.

---

## 5. Шапка заказа (Configuration Context)

### 5.1 Шапки заказа

Шапка — набор свойств, применяемых к позициям заказа.

**Особенности:**
- Шапка выбирается по типу заказа
- Свойства могут быть включены / отключены
- Свойства из шапки наследуются позициями заказа

### 5.2 Свойства шапки

Свойства:
- Материал заказа
- Модель фасада
- Филёнка
- Материал филёнки
- Текстура
- Цвет
- Патина
- Глянцевость
- Присадка (bool)
- Термошов (bool)
- Доп. параметры отделки

---

## 6. Номенклатуры и свойства

### 6.1 Номенклатура (Product)

Номенклатура — базовый элемент расчёта.

**Поля:**
- name
- category
- description
- unit
- defaultLength
- defaultWidth
- defaultDepth

### 6.2 Свойства номенклатуры

Каждая номенклатура имеет набор свойств через сущность `productProperty`:

| Поле | Назначение |
|-----|------------|
| propertyID | Свойство |
| isActive | Включено по умолчанию |
| defaultValue | Значение по умолчанию |

Свойства с `isActive = false` могут быть включены вручную в заказе.

---

## 7. Зависимости значений свойств

### 7.1 Механизм зависимостей

Система поддерживает зависимости вида:

> ЕСЛИ выбрано (Property A = Value X) → ТО автоматически установить (Property B = Value Y)

### 7.2 Назначение
- Автозаполнение
- Исключение ошибок
- Формализация технологических правил

---

## 8. Ценообразование

### 8.1 Базовая цена

Каждая номенклатура имеет **единственную базовую цену**.

### 8.2 Модификаторы цены

Цена изменяется **исключительно через модификаторы**:
- Свойство
- Значение свойства
- Изменение цены (+ / -)

### 8.3 Расчёт стоимости позиции

1. Базовая цена
2. Применение модификаторов
3. Умножение на площадь / п.м.
4. Применение коэффициента

---

## 9. Позиции заказа

### 9.1 OrderItem

Каждая строка заказа:
- может быть добавлена или скопирована
- содержит геометрию
- содержит собственные свойства

**Расчёты:**
- Площадь = длина × ширина × количество
- Погонный метр = длина × количество

---

## 10. Пользователи и роли

### 10.1 Пользователь

Пользователь — универсальная сущность для:
- Клиентов
- Менеджеров
- Работников

### 10.2 Дополнительные данные

Произвольные данные пользователя хранятся в `usersProperty`:
- несколько телефонов
- реквизиты
- примечания

---

## 11. Права доступа

- Права влияют на:
  - видимость колонок
  - доступ к ценам
  - действия над заказом

Реализация: RBAC + domain rules.

---

## 12. Логирование и аудит

Система логирует:
- изменения заказа
- изменения свойств
- перерасчёты цены

Лог — обязательная часть бизнес-логики.

---

## 13. Структура проекта

```text
src/
 └─ modules/
    ├─ order/
    ├─ product/
    ├─ pricing/
    ├─ property/
    ├─ user/
    ├─ configuration/
    └─ audit/
```

Каждый модуль:
- domain
- application
- infrastructure
- presentation

---

## 14. Итог

Данная архитектура:
- полностью повторяет ТЗ
- не содержит упрощений
- готова к поэтапной реализации
- масштабируема и тестируема

Документ является **базой для разработки**, а не декларацией намерений.

